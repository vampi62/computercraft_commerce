global_createur = "vampi62"
global_repo_git = "https://github.com/vampi62/computercraft_commerce"
global_os_version = os.version()
if global_os_version == "CraftOS 1.8" then
	-- pas de changement
elseif global_os_version == "CraftOS 1.7" then
	-- dans craftos 1.7 require n'existe pas, la fonction shell.run similaire car elle utilise un environnement partagé
	function require(fichier)
		shell.run(fichier..".lua")
	end
end

-- chargement des variables --
if not fs.isDir("config") then
	fs.makeDir("config")
end
global_config_http = "config/config.lua"
global_config_session = "config/session.lua"
global_config_panier = "config/panier.lua"
global_config_mdp_local = "config/mdpsha.lua"
global_config_version = "config/version.lua"
require("initvar")


local list = fs.list("config/")
for j = 1, #list do
	require("config/"..string.sub(list[j],1,-5))
end

global_local_config = {resync_time=5,delay_seconde=5,azerty=true}

global_min_y_page = 5
global_max_y_page = 15

global_http_enable = false
global_http_error_message = {}
global_local_error_message = {
	[1]="erreur - les deux mot de passe ne correspondent pas",
	[2]="erreur - un champ est vide",
	[3]="erreur - mot de passe incorrect",
	[4]="erreur - le serveur http ne fonctionne pas",
	[5]="erreur - pas de reponse du serveur http",
	[10]="succes - mot de passe bon",
	[11]="succes - mot de passe sauvegarder",
	[12]="succes - config reseau sauvegarder",
	[21]="erreur - la connexion au serveur API ne fonctionne pas",
	[22]="erreur - la connexion au serveur LUA ne fonctionne pas"
}

--[[
variable init par les fichiers config

global_url = '__ip__or__domain__'
global_port = '80'
global_api_uri = 'api_computercraft'
global_lua_uri = 'lua'
global_systeme_nom = 'client'

global_session = {} -- {pseudo='', mdp='', compte=0, email='', defautadresse={nom='',type='',coo='',description=''}, nbr_offre=0, role='', last_login=''}

global_panier = {} -- {{id_offre=0,quant=0,nom=""},{id_offre=0,quant=0,nom=""}}

global_login_pc = () mdp hash256
]]--

-- init table d'echange entre les programmes --
-- receive_rednet

global_rednet_id = 0
global_rednet_message = "" -- string or table

-- touch
global_value_touch = {}

-- click
global_value_click = {}

-- scroll
global_limite_scroll_haut = false
global_limite_scroll_bas = false
global_scroll = 0

-- ntp
global_ntp = {seconde = 0,minute = 0,heure = 0,jour = 1,mois = 1,annee = 1974,sync = 5}

-- clavier
global_maint_clavier = ""
global_clavier = ""

-- affichage_term
global_refresh_term = false
global_term_objet_select = {} -- {{back_color=0,ymin=0,ymax=0,xmin=0,xmax=0,value={action="",id=0,value=0,exe=""}},{back_color=0,ymin=0,ymax=0,xmin=0,xmax=0,name="",value={action="",id=0,value=0,exe=""}}}
global_term_objet_write = {} -- {{back_color=0,text_color=0,ymin=0,ymax=0,xmin=0,xmax=0,text=""},{back_color=0,text_color=0,ymin=0,ymax=0,xmin=0,xmax=0,text=""}}

-- affichage_mon
global_monitor_objet_select = {} -- {side_monitor1={back_color=0,ymin=0,ymax=0,xmin=0,xmax=0,value={action="",id=0,value=0,exe=""}},side_monitor2={back_color=0,ymin=0,ymax=0,xmin=0,xmax=0,value={action="",id=0,value=0,exe=""}}}
global_monitor_objet_write = {} -- {side_monitor1={back_color=0,text_color=0,ymin=0,ymax=0,xmin=0,xmax=0,text=""},side_monitor2={back_color=0,text_color=0,ymin=0,ymax=0,xmin=0,xmax=0,text=""}}

global_monitor_list = {} -- {side_monitor1=1,side_monitor2=1} -- remplacer la valeur par la taille du texte sur cette ecran
global_refresh_mon = {} -- {false,false} -- cette table a la meme taille que "global_monitor_list"
global_monitor_api = {} -- {function,function} -- fonction a utiliser pour les moniteurs ex: global_monitor_api[x].write() -- cette table a la meme taille que "global_monitor_list"

for k ,v in pairs(global_monitor_list) do
	global_monitor_api[k] = peripheral.wrap(k)
	global_refresh_mon[k] = false
end

global_new_version = {}

global_page_visible = 0

global_histo_nav = {}
global_edit_variable = {}
global_clavier_maj = {lock=false,shift=false,altgr=false}
-- position min et max pour la generation du texte des tableaux

global_message = ""
global_compteur_tempo_message_http = 0

-- liste recuperer par http
global_liste_adresse = {}
global_liste_transaction = {}
global_liste_commande = {}
global_liste_offre = {}


-- chargement des fonctions --
local list = fs.list("fonction/")
for j = 1, #list do
	require("fonction/"..string.sub(list[j],1,-5))
end
reinitbox()
recup_http_config()
--[[
recup_http_config()

reinitbox()

remplir_variable(variable_a_remplir,variable_a_coller)

changementpage(new_page)

string = convert_grand_nombre(nombre)

string = convertkey_number_altgr(numberkey)

screen_function = duplicate_screen(ecran1, ecran2)

save_file(nom, data)

save_var_file(nom, data, name)

save_table_file(nom, data, name)

string_or_table = load_file(nom)

string = sha256(msg)

string_or_table = http_get(action,api_bool)

bool = imprimante(printer,action,text,x,y,color)

int = get_me_objet(me_controle,fingerprint_objet)

table = get_tank_objet(tank)

table = rsa_key_gen()

string = crypt(key, number)

table = split(astring, delimiter)
]]--


changementpage(0)
if global_login_pc ~= nil then
	changementpage(10)
end

if global_http_enable then
	if global_session["pseudo"] ~= "" and global_session["mdp"] ~= "" then
		id_message_http = http_get("listuserdata&mdp="..global_session["mdp"].."&pseudo="..global_session["pseudo"],true)
		local temp_mdp_init = global_session["mdp"]
		if type(id_message_http) == "table" then
			global_session = id_message_http
			global_session["mdp"] = temp_mdp_init
		else
			global_session = {pseudo='', mdp='', compte=0, email='', defautadresse={nom='',type='',coo='',description=''}, nbr_offre=0, role='', last_login=''}
		end
		save_table_file(global_config_session, textutils.serialize(global_session), "global_session")
		id_message_http = nil
	end
end


--[[
	--page--
-1 = retour dans la pile

0  = setup_login_pc

10 = menu

20 = login
21 = inscription
22 = mdp_oublie
23 = code_mdp_oublie
25 = update_mdp
26 = update_mail
27 = achat_offre

30 = offre
31 = panier
33 = plus_info_offre

50 = commande_client
53 = plus_info_commande
54 = litige_commande

60 = transaction
63 = plus_info_transaction
64 = litige_transaction

90 = adresse
91 = add_adresse
92 = edit_adresse

101 = filtre_offre
102 = filtre_transac
103 = filtre_commande
104 = filtre_adresse

130 = offre_commerce
133 = edit_offre_commerce

150 = commande_commerce
153 = edit_commande_commerce

160 = transaction_commerce
163 = plus_info_transaction_commerce


200 = demande_login_pc
201 = change_login_pc
202 = menu_config
203 = mise_a_jour
204 = infos
205 = edit config
]]--
--[[
	--action--
-edit_config
-reboot
-shutdown
-disable_message
-setlocalmdp
-changelocalmdp
-localmdp
-deconnexion
-connexion
-inscription
-mdpoublie
-codemail
-changemdp
-changemail
-achatoffre
]]--
--[[
type de variable pour global_variable
text
code --> une variable "nomdevariable_len" est creer elle a le meme nombre de caratere mais seulement des "*"
int --> ne prend que des chiffres sur le clavier et peut etre modifier avec la molette de souris
float --> idem que int mais l'increment de la molette se fait en pas de 0.1, pas de limite avec les chiffres après la virgule

select -- plus tard

]]--
--[[

exemple structure fichier page

-- si il y a des champs editable a afficher et qu'il sont près remplie
local variable_a_remplir = {"ip","port","uriapi","urilua"}
local variable_a_coller = {global_url,global_port,global_api_uri,global_lua_uri}
remplir_variable(variable_a_remplir,variable_a_coller)


if idpage = x then
	titre de page -- si plusieurs page dans le fichier
if idpage = y then
	titre de page -- si plusieurs page dans le fichier
end

titre de page -- si une page dans le fichier

text

text_variable (par variable les textes issue de la variable global_variable["xxxx"])
selection_variable

selection_bouton
]]--





-- chargement des programmes --
local list = fs.list("programme/")
for j = 1, #list do
	require("programme/"..string.sub(list[j],1,-5))
end

-- chargement des systeme --
local list = fs.list("backend/")
for j = 1, #list do
	require("backend/"..string.sub(list[j],1,-5))
end

-- chargement des page --
local list = fs.list("page/")
for j = 1, #list do
	require("page/"..string.sub(list[j],1,-5))
end

-- run prog --

os.setComputerLabel(global_systeme_nom.."-"..global_systeme_version)

function main()
	if not fs.exists("config/update.lua") then
		parallel.waitForAny(scroll, click, clavier, up_clavier, affichage_term, ntp, backend)
		sleep(5)
	else
		require("update")
	end
end
while true do
	local etat, error_mes = pcall(main)
	if not etat then
		local file = fs.open('log', 'a')
		file.writeLine(os.day()..':'..os.time()..' '..error_mes)
		file.close()
	end
	sleep(0.2)
end